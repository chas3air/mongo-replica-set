# MongoDB Replica Set Infrastructure Documentation

–î–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ **MongoDB Replica Set** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ **HAProxy**.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

–ö–ª–∞—Å—Ç–µ—Ä —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

* **4 —É–∑–ª–∞ –¥–∞–Ω–Ω—ã—Ö** (`mongodb1` - `mongodb4`): –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —á–ª–µ–Ω—ã —Ä–µ–ø–ª–∏–∫–∞-—Å–µ—Ç–∞.
* **1 –ê—Ä–±–∏—Ç—Ä** (`mongo-arbiter`): –£–∑–µ–ª –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ Primary.
* **HAProxy**: –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫, —Ä–∞–∑–¥–µ–ª—è—é—â–∏–π –ø–æ—Ç–æ–∫–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å.
* **Mongo-init**: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π –ø–µ—Ä–≤–∏—á–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∫–ª–∞—Å—Ç–µ—Ä–∞.
* **Go-app**: –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (Environment Variables)

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Ñ–∞–π–ª–µ `.env`:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- |
| `MONGO_INITDB_ROOT_USERNAME` | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (root) –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. |
| `MONGO_INITDB_ROOT_PASSWORD` | –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. |
| `MONGO_REPLICA_SET` | –ò–º—è –Ω–∞–±–æ—Ä–∞ —Ä–µ–ø–ª–∏–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `rs0`). |
| `MONGO_PORT` | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç —É–∑–ª–æ–≤ –¥–∞–Ω–Ω—ã—Ö (27017). |
| `MONGO_ARBITER_PORT` | –ü–æ—Ä—Ç –∞—Ä–±–∏—Ç—Ä–∞ (27018). |
| `MONGO_KEYFILE_PATH` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. |

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **RBAC**: –î–æ—Å—Ç—É–ø –∑–∞—â–∏—â–µ–Ω –ª–æ–≥–∏–Ω–æ–º –∏ –ø–∞—Ä–æ–ª–µ–º root-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
2. **Internal Auth**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `keyFile` (`mongodb.key`). –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É–∑–ª—ã —Ä–µ–ø–ª–∏–∫–∞-—Å–µ—Ç–∞ –º–æ–≥–ª–∏ –¥–æ–≤–µ—Ä—è—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥—É.

---

## 1. –ó–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∞

* ### 1. –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã
```bash
cp .env .example.env
```

* ### 2. –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á *mongodb.key*

```bash
openssl rand -base64 754 > mongodb.key
chmod 600 mongodb.key
sudo chown 999:999 mongodb.key
```

* ### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä

```bash
docker-compose up --build
```

## 2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞

`Ctrl + C`

```bash
docker compose down -v
```

---

## ‚öñÔ∏è –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ (HAProxy)

HAProxy –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –µ–¥–∏–Ω—É—é —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ä–∞–∑–¥–µ–ª—è—è –ø–æ—Ä—Ç—ã –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü–∏–π:

| –í–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç | –¢–∏–ø —Ç—Ä–∞—Ñ–∏–∫–∞ | –õ–æ–≥–∏–∫–∞ |
| --- | --- | --- |
| **27019** | **Write (–ó–∞–ø–∏—Å—å)** | –ù–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ `mongodb1` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Primary). |
| **27018** | **Read (–ß—Ç–µ–Ω–∏–µ)** | –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ Round-robin –º–µ–∂–¥—É `mongodb2`, `mongodb3`, `mongodb4`. |
| **8404** | **Stats** | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã (–ª–æ–≥–∏–Ω: `admin`, –ø–∞—Ä–æ–ª—å: `password`). |

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í –¥–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ HAProxy –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å—Ç–∞—Ç–∏—á–Ω–æ. –ï—Å–ª–∏ `mongodb1` –≤—ã–π–¥–µ—Ç –∏–∑ —Å—Ç—Ä–æ—è –∏ Primary —Å—Ç–∞–Ω–µ—Ç –¥—Ä—É–≥–æ–π —É–∑–µ–ª, –ø–æ—Ä—Ç –∑–∞–ø–∏—Å–∏ `27019` –ø–æ—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ `haproxy.cfg`.

---

## üõ† –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏

```bash
docker exec -it mongodb1 mongosh -u root -p example --eval "rs.status()"

```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞

–î–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: `http://localhost:8404/stats`

---

## 7. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Go)

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä `go-mongodb-driver`. –í –¥–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏.

### –õ–æ–≥–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ (–∏–ª–∏ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π):

1. **Write Client**: –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ø–æ—Ä—Ç—É `27019` (HAProxy ‚Üí Primary). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (`Insert`, `Update`, `Delete`).
2. **Read Client**: –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ø–æ—Ä—Ç—É `27018` (HAProxy ‚Üí Secondaries). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–±–æ—Ä–∫–∏ (`Find`, `Aggregate`) —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `readPreference=secondary`.

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞:** 2026 –≥–æ–¥.

---
